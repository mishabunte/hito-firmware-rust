import { VerticalBox, HorizontalBox } from "std-widgets.slint";
import "RobotoMono-Light.ttf";

component BrightnessLogo inherits Rectangle {
    width: 20px;
    height: 20px;

    // Position properties (can be set from parent)
    in property <length> scale-x: -225px;
    in property <length> scale-y: 0px;

    // Properties
    property <int> brightness: 95;
    in-out property <bool> scale-shown: false;
    property <bool> logo_pressed: false;
    property <bool> scale-pressed: false;
    property <duration> hide-timer-duration: 5000ms;


    // Callbacks
    callback brightness-changed(int);
    callback scale-shown-cb(bool);

    // Brightness icon button
    Image {
        source: @image-url("../res/img/brightness.png");
        width: parent.width;
        height: parent.height;
        visible: !scale-shown;
    }

    // Brightness scale (slider) - only visible when scale-shown is true
    if scale-shown: Rectangle {
        x: scale-x; // Position to the left of the button
        y: scale-y;  // Position below the button
        width: 190px;
        height: 20px;
        background: white;
        border-color: transparent;
        border-width: 1px;

        // Scale background track
        Rectangle {
            x: 0px;
            y: parent.height / 2 - 2px;
            width: parent.width;
            height: 4px;
            background: #4740403c;
        }

        // Scale filled portion
        Rectangle {
            x: 0px;
            y: parent.height / 2 - 2px;
            width: parent.width * brightness / 100;
            height: 4px;
            background: #474040eb;
        }

        // Scale handle (brightness icon)
        Image {
            source: @image-url("../res/img/brightness.png");
            x: parent.width * brightness / 100 - self.width / 2;
            y: 0px;
            width: 20px;
            height: 20px;
        }

        // Touch area for the scale
        scale-touch := TouchArea {
            width: parent.width;
            height: parent.height * 3; // Larger touch area

            pointer-event(event) => {
                if (event.kind == PointerEventKind.down || event.kind == PointerEventKind.move) {
                    if (scale-touch.pressed) {
                      scale-pressed = true;
                        // Update brightness based on touch position
                        brightness = max(1, min(100, round(scale-touch.mouse-x * 100 / scale-touch.width)));
                        brightness-changed(brightness);
                    }
                } else if (event.kind == PointerEventKind.up) {
                    scale-pressed = false;
                }
            }
        }
    }

    // Main touch area for the brightness button
    TouchArea {
        width: parent.width + 20px; // Larger touch area
        height: parent.height + 20px;
        x: -10px;
        y: -10px;

        pointer-event(event) => {
            if (event.kind == PointerEventKind.down) {
                logo_pressed = true;
            } else if (event.kind == PointerEventKind.up) {
                if (logo_pressed) {
                    logo_pressed = false;
                    scale-shown = !scale-shown;
                    scale-shown-cb(scale-shown);
                    if (scale-shown) {
                        hide-timer.restart();
                    }
                }
            }
        }
    }

    // Auto-hide timer
    hide-timer := Timer {
        interval: hide-timer-duration;
        running: scale-shown && !scale-pressed;
        triggered => {
            scale-shown = false;
            scale-shown-cb(scale-shown);
        }
    }
}

export component HitoWindow inherits Window {
    width: 320px;
    height: 240px;
    background: white;

    default-font-family: "Roboto Mono";

    // Properties that can be overridden by child components
    in property <bool> show-brightness: true;
    in property <bool> is-lockscreen: false;

    // Internal brightness control state
    property <bool> brightness-scale-shown: false;

    // Brightness control in top-right corner
    brightness-control := BrightnessLogo {
        scale-x: is-lockscreen ? -225px : -225px; // Use component default (-225px) if not lock screen
        scale-y: is-lockscreen ? 175px : 0px; // Use component default (0px) if not lock screen
        x: parent.width - 20px - 10px; // 10px margin from right edge
        y: 5px; // 5px margin from top
        visible: show-brightness;
        brightness-changed(value) => {
            // Forward the callback to HitoWindow level so Rust can catch it
            root.brightness-changed(value);
        }
        scale-shown-cb(shown) => {
            brightness-scale-shown = shown;
            root.brightness-scale-shown-changed(shown);
        }
    }

    // Global touch area to hide brightness scale when clicking outside - only active when scale is shown
    if brightness-scale-shown: TouchArea {
        width: parent.width;
        height: parent.height;
        z: -1; // Above other elements to capture all clicks

        pointer-event(event) => {
            if (event.kind == PointerEventKind.down) {
                // Check if click is outside brightness control area
                if (self.mouse-x < brightness-control.x - 10px ||
                    self.mouse-x > brightness-control.x + brightness-control.width + 200px ||
                    self.mouse-y < brightness-control.y - 10px ||
                    self.mouse-y > brightness-control.y + brightness-control.height + 10px) {
                    brightness-control.scale-shown = false;
                    brightness-scale-shown = false;
                    root.brightness-scale-shown-changed(false);
                }
            }
        }
    }

    // Callbacks that child components can connect to
    callback brightness-changed(int);
    callback brightness-scale-shown-changed(bool);
}