import { VerticalBox, HorizontalBox } from "std-widgets.slint";
import "../../res/fonts/RobotoMono-Light.ttf";
import { BrightnessLogo} from "BrightnessController.slint";
import { BatteryLevel, BatteryController } from "Battery.slint";
import { Palette } from "Palette.slint";

component HeaderBar {
    in-out property<string> title;
    in property<bool> brightness-scale-shown: false;
    if title != "": Rectangle {
        y: 10px;
        background: Palette.green;
        width: 1.1*header.width;
        height: 1.1*header.height;
        visible: !parent.brightness-scale-shown;
        header := Text {
            y: 1px;
            text: title;
            font-size: 20px;
            font-family: "Roboto Mono";
            font-italic: false;
            font-weight: 1000;
            horizontal-alignment: center;
            wrap: word-wrap;
        }
    }
}

export component HitoWindow inherits Window {
    width: 320px;
    height: 240px;
    background: white;

    default-font-family: "Roboto Mono";

    // Properties that can be overridden by child components
    in property <bool> show-brightness: true;
    in property <bool> is-lockscreen: false;
    in-out property <string> header-title: "";

    // Internal brightness control state
    out property <bool> brightness-scale-shown: false;
    HeaderBar {
        y: 0px;
        title: root.header-title;
        brightness-scale-shown: root.brightness-scale-shown;
    }

    // Layout container for positioning elements
    HorizontalLayout {
        width: parent.width;
        spacing: 7px;
        padding-right: 9px;
        padding-top: 5px;
        alignment: end;
        // Brightness control in top-right corner
        brightness-control := BrightnessLogo {
          width: 20px;
          height: 20px;
          scale-x: -(parent.width / 2 - self.width / 2 - parent.padding-right - parent.spacing - 20px);
          scale-y: is-lockscreen ? 175px : 0px;
          visible: show-brightness;
          scale-shown-cb(shown) => {
              brightness-scale-shown = shown;
              root.brightness-scale-shown-changed(shown);
          }
        }
      
        Rectangle {
          width: 20px;
          height: 20px;
          battery-indicator := BatteryLevel {
            visible: show-brightness;
        }
      }
    }

    // Global touch area to hide brightness scale when clicking outside - only active when scale is shown
    if brightness-scale-shown: TouchArea {
        width: parent.width;
        height: parent.height;
        z: -1; // Above other elements to capture all clicks

        pointer-event(event) => {
            if (event.kind == PointerEventKind.down) {
                // Check if click is outside brightness control area
                if (self.mouse-x < brightness-control.x - 10px ||
                    self.mouse-x > brightness-control.x + brightness-control.width + 200px ||
                    self.mouse-y < brightness-control.y - 10px ||
                    self.mouse-y > brightness-control.y + brightness-control.height + 10px) {
                    brightness-control.scale-shown = false;
                    brightness-scale-shown = false;
                    root.brightness-scale-shown-changed(false);
                }
            }
        }
    }

    callback brightness-scale-shown-changed(bool);
    callback battery-level-requested() -> int;
}